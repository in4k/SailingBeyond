const char* common_init_frag = "#version 430\nlayout(location=3)uniform vec4 U[4];layout(location=0)out vec4 C0;layout(location=1)out vec4 C1;layout(location=2)out vec4 C2;layout(binding=0)uniform sampler2D B0;layout(binding=1)uniform sampler2D B1;layout(binding=2)uniform sampler2D B2;in vec2 ouv;\n#define iTime (U[0].x)\n#define FOV 110.0\n#define FOG .06\n#define PI 3.14159265\n#define TAU (2*PI)\n#define PHI (1.618033988749895)\n#define FAR 350\n#define INFINITY 1e32\nprecision highp float;vec2 uv;vec3 vuv=vec3(0.,1.,0.),keyTime,s1_ob;float pattern;vec4 gt;void gT(){gt=texelFetch(B2,ivec2(4,0),0);}\n#define PATTERN_TIME 5.485714\n#define CI keyTime = texelFetch(B2, ivec2(4, 0), 0).rgb; pattern = iTime / PATTERN_TIME; uv = ouv * .5; if (abs(uv.y) > .4) discard;\nstruct geometry{float d;int mat;float specular;float diffuse;vec4 color;vec3 sp;vec3 hp;float mirror;float i;float glow;};float saturate(float a){return clamp(a,0.0,1.0);}geometry geoU(geometry g1,geometry g2){if(g1.d<g2.d)return g1;return g2;}float smin(float a,float b,float k){float res=exp(-k*a)+exp(-k*b);return-log(res)/k;}float vmax(vec2 v){return max(v.x,v.y);}float vmax(vec3 v){return max(max(v.x,v.y),v.z);}float vmax(vec4 v){return max(max(v.x,v.y),max(v.z,v.w));}float pMod1(inout float p,float size){float halfsize=size*0.5;float c=floor((p+halfsize)/size);p=mod(p+halfsize,size)-halfsize;return c;}vec3 pMod3(inout vec3 p,vec3 size){vec3 c=floor((p+size*0.5)/size);p=mod(p+size*0.5,size)-size*0.5;return c;}float pMirror(inout float p,float dist){float s=sign(p);p=abs(p)-dist;return s;}vec2 pMirrorOctant(inout vec2 p,vec2 dist){vec2 s=sign(p);pMirror(p.x,dist.x);pMirror(p.y,dist.y);if(p.y>p.x)p.xy=p.yx;return s;}float pModInterval1(inout float p,float size,float start,float stop){float halfsize=size*0.5;float c=floor((p+halfsize)/size);p=mod(p+halfsize,size)-halfsize;if(c>stop){p+=size*(c-stop);c=stop;}if(c<start){p+=size*(c-start);c=start;}return c;}float pModPolar(inout vec2 p,float repetitions){float angle=2.*PI/repetitions;float a=atan(p.y,p.x)+angle/2.;float r=length(p);float c=floor(a/angle);a=mod(a,angle)-angle/2.;p=vec2(cos(a),sin(a))*r;if(abs(c)>=(repetitions/2.))c=abs(c);return c;}void pR(inout vec2 p,float a){p=cos(a)*p+sin(a)*vec2(p.y,-p.x);}void pR45(inout vec2 p){p=(p+vec2(p.y,-p.x))*sqrt(0.5);}float fOpUnionStairs(float a,float b,float r,float n){float d=min(a,b);vec2 p=vec2(a,b);pR45(p);p=p.yx-vec2((r-r/n)*0.5*sqrt(2.));p.x+=0.5*sqrt(2.)*r/n;float x=r*sqrt(2.)/n;pMod1(p.x,x);d=min(d,p.y);pR45(p);return min(d,vmax(p-vec2(0.5*r/n)));}float fBox(vec3 p,vec3 b){vec3 d=abs(p)-b;return length(max(d,vec3(0)))+vmax(min(d,vec3(0)));}float fBox2Cheap(vec2 p,vec2 b){return vmax(abs(p)-b);}float fSphere(vec3 p,float r){return length(p)-r;}float fCylinder(vec3 p,float r,float h){float d=length(p.xz)-r;d=max(d,abs(p.y)-h);return d;}float ring(vec3 p,vec4 s){return max(fCylinder(p,s.x,s.y),-fCylinder(p,s.x-s.z,s.y*2.));}float fDisc(vec3 p,float r){float l=length(p.xz)-r;return l<0?abs(p.y):length(vec2(p.y,l));}float fLineSegment(vec3 p,vec3 a,vec3 b){vec3 ab=b-a;float t=saturate(dot(p-a,ab)/dot(ab,ab));return length((ab*t+a)-p);}float fCapsule(vec3 p,float r,float c){return mix(length(p.xz)-r,length(vec3(p.x,abs(p.y)-c,p.z))-r,step(c,abs(p.y)));}float fTorus(vec3 p,float smallRadius,float largeRadius){return length(vec2(length(p.xz)-largeRadius,p.y))-smallRadius;}geometry fShip(vec3 bp){geometry ship,shield,homes,pipe,engine,tail;if(length(bp)>2.){ship.d=length(bp)-.5;return ship;}pR(bp.zy,keyTime.r*10.);shield.diffuse=1.;shield.specular=1.;shield.mirror=1.;shield.mat=-1;shield.color=vec4(.0);shield.d=1e9;homes=pipe=engine=shield;shield.d=fBox(bp,vec3(2.5));shield.mirror=.7;vec3 p=bp.zyx,p2=bp;;vec3 pp=p;float d1,d2;pModPolar(p.xy,12.);pMirrorOctant(p.xz,vec2(.055,.01));engine.d=fBox(pp+vec3(0.,0.,.1),vec3(.02,.02,.05)*vec2(.4-length(pp)*17.3,.1).xxy);pR45(p.xy);d2=fBox(p,vec3(.2,.2,.2)*.1);d2=min(d2,engine.d);engine.d=fOpUnionStairs(d2,engine.d,.1,7.);if(length(pp.xyz)<.04)engine.color=vec4(1.,.5,0.,0.)*5.;engine.sp=p;engine.mirror=0.;vec3 c=bp+vec3(.2,0.,0.);shield.d=max(length(c)-0.2,-(length(c-vec3(.13,0.,0.))-.32))-.01;shield.sp=c;pipe.d=fCapsule(c.yxz,.01,.1);pipe.sp=c.yxz;pipe.mirror=0.;pipe.color=vec4(0.);bp.x+=.2;pModPolar(bp.yz,6.);homes.d=fBox(bp,vec3(.03,.07,.01));homes.sp=bp;homes.mirror=0.;homes.color=vec4(1.);return geoU(engine,geoU(shield,geoU(pipe,homes)));vec3 pp2=pp;pp.z-=fract(iTime*5.)*.03;float a=pModInterval1(pp.z,.03,1.,6.);;tail.d=fTorus(pp.yzx,.004,.05-pp2.z*.2);tail.color=vec4(1.,0.5,0.,0.);return geoU(tail,geoU(engine,geoU(shield,geoU(pipe,homes))));}float tritun(vec3 p){pModPolar(p.yz,3.);p.y-=.2;p.z-=1.2;return fBox(p,vec3(.01,.01,5.));}float trits(vec3 bp){bp.x-=7.;float i=pModInterval1(bp.z,2.,-20.,26.);return tritun(bp.zyx);}vec3 hash33_(vec3 p){float n=sin(dot(p,vec3(7,157,113)));return fract(vec3(2097152,262144,32768)*n);}\n#define M0 1597334673U\n#define M1 3812015801U\n#define M2 uvec2(M0, M1)\n#define M3 uvec3(M0, M1, 2798796413U)\nfloat hash11(float q){uvec2 n=int(q)*M2;return float((n.x^n.y)*M0)*(1.0/float(0xffffffffU));}float hash12(vec2 p){uvec2 q=uvec2(ivec2(p))*M2;uint n=(q.x^q.y)*M0;return float(n)*(1./float(0xffffffffU));}vec3 hash33(vec3 p){uvec3 q=uvec3(ivec3(p))*M3;q=(q.x^q.y^q.z)*M3;return vec3(q)*(1.0/float(0xffffffffU));}float voronoi(vec3 p){vec3 b,r,g=floor(p);p=fract(p);float d=1.;for(int j=-1;j<=1;j++){for(int i=-1;i<=1;i++){b=vec3(i,j,-1);r=b-p+hash33(g+b);d=min(d,dot(r,r));b.z=0.0;r=b-p+hash33(g+b);d=min(d,dot(r,r));b.z=1.;r=b-p+hash33(g+b);d=min(d,dot(r,r));}}return d;}float noiseLayers(in vec3 p){vec3 t=vec3(0.,0.,p.z);float tot=0.,sum=0.,amp=1.;for(int i=0;i<2;i++){tot+=voronoi(p+t)*amp;p*=2.0;t*=1.5;sum+=amp;amp*=0.5;}return tot/ sum;}float noiseF(in vec2 p){vec2 i=floor(p),f=fract(p),u=f*f*f*(3.-2.*f);return mix(mix(hash12(i+vec2(0.,0.)),hash12(i+vec2(1.,0.)),u.x),mix(hash12(i+vec2(0.,1.)),hash12(i+vec2(1.,1.)),u.x),u.y);}float noiseFF(in vec2 uv){uv*=2.;mat2 m=mat2(1.6,1.2,-1.2,1.6)*1.25;float f=.5*noiseF(uv);uv=m*uv;f+=.2500*noiseF(uv);uv=m*uv;f+=.1250*noiseF(uv);uv=m*uv;f+=.0625*noiseF(uv);uv=m*uv;return f;}float noise_3(in vec3 p){vec3 i=floor(p);vec3 f=fract(p);vec3 u=1.-(--f)*f*f*f*-f;vec2 ii=i.xy+i.z*vec2(5.0);float a=hash12(ii+vec2(0.0,0.0));float b=hash12(ii+vec2(1.0,0.0));float c=hash12(ii+vec2(0.0,1.0));float d=hash12(ii+vec2(1.0,1.0));float v1=mix(mix(a,b,u.x),mix(c,d,u.x),u.y);ii+=vec2(5.0);a=hash12(ii+vec2(0.0,0.0));b=hash12(ii+vec2(1.0,0.0));c=hash12(ii+vec2(0.0,1.0));d=hash12(ii+vec2(1.0,1.0));float v2=mix(mix(a,b,u.x),mix(c,d,u.x),u.y);return max(mix(v1,v2,u.z),0.);}float fbm(vec3 x){float r=0.0;float w=1.0,s=1.0;for(int i=0;i<4;i++){w*=0.25;s*=3.;r+=w*noise_3(s*x);}return r;}float noiseShort(vec3 p){vec3 ip=floor(p);p-=ip;vec3 s=vec3(7,157,113);vec4 h=vec4(0.,s.yz,s.y+s.z)+dot(ip,s);p=p*p*(3.-2.*p);h=mix(fract(sin(h)*43758.5),fract(sin(h+s.x)*43758.5),p.x);h.xy=mix(h.xz,h.yw,p.y);return mix(h.x,h.y,p.z);}geometry map(vec3 ro);geometry trace(in vec3 ro,in vec3 rd){geometry r;float d=0.;for(int i=0;i<149;i++){r=map(ro+rd*d);d+=r.d*(.6+i/ 1e2);r.i=i;if(abs(r.d)<0.001||d>FAR)break;}r.d=d;return r;}vec3 stars(in vec3 p){vec3 c=vec3(0.);float res=21100.;for(float i=0.;i<3.;i++){vec3 q=fract(p*(.15*res))-0.5;vec3 id=floor(p*(.15*res));vec2 rn=hash33(id).xy/ 14.;float c2=1.-smoothstep(0.,.6,length(q));c2*=step(rn.x,.0005+i*i*0.001);c+=c2*(mix(vec3(1.0,0.49,0.1),vec3(0.75,0.9,1.),rn.y)*0.25+0.75);p*=1.4;}return c*c*.7;}vec3 normals(vec3 p){float d=map(p).d;return normalize(vec3(map(p+vec3(.001,0,0)).d-d,map(p+vec3(0,.001,0)).d-d,map(p+vec3(0,0,.001)).d-d));}float softShadow(vec3 ro,vec3 lp,float k){const int maxIterationsShad=18;vec3 rd=(lp-ro);float shade=1.;float dist=1.;float end=max(length(rd),0.1);float stepDist=end/ float(maxIterationsShad);rd/=end;for(int i=0;i<maxIterationsShad;i++){float h=map(ro+rd*dist).d;shade=min(shade,smoothstep(0.0,1.0,k*h/ dist));dist+=min(h,stepDist*2.);if(h<0.001||dist>end)break;}return min(max(shade,0.4),1.0);}float getAO(vec3 hitp,vec3 normal,float dist){vec3 spos=hitp+normal*dist;float sdist=map(spos).d;return clamp(sdist/ dist,0.4,1.0);}vec4 getObjectColor(vec3 p,vec3 n,geometry obj){vec4 col=vec4(.0);if(obj.mat==-1){return vec4(0.5);};if(obj.mat==0){return vec4(2.);};if(obj.mat==2){return vec4(1.,.6,0.3,1.)+texture(B2,obj.hp.xy*0.22).rrrr;};if(obj.mat==3){return vec4(1.,1.,0.3,1.)*.3;}if(obj.mat==4){return vec4(1.);}if(obj.mat==5){return vec4(5.);}if(obj.mat==6){return vec4(1.,.5,.5,0.);}if(obj.mat==51){return vec4(1.,.5,.5,0.);}return col;}vec4 doColor(in vec3 sp,in vec3 rd,in vec3 sn,in vec3 lp,geometry obj){vec4 sceneCol=vec4(0.0);lp=sp+lp;vec3 ld=lp-sp;float lDist=max(length(ld/ 2.),0.001);ld/=lDist;float atten=1./(1.0+lDist*0.025+lDist*lDist*0.2);float diff=max(dot(sn,ld),.9)*1.;float spec=pow(max(dot(reflect(-ld,sn),-rd),.2),.05);vec4 objCol=getObjectColor(sp,sn,obj);sceneCol.rgb+=(objCol.rgb*(diff+.0015)+spec*.1);return sceneCol;}vec3 applyFog(in vec3 rgb,in float distance,in vec3 rayOri,in vec3 rayDir,in vec3 fogCol){rayOri.y+=21.;float c=2.;float b=0.0045;float fogAmount=c*exp(-rayOri.y*b)*(1.0-exp(-distance*rayDir.y*b))/rayDir.y;fogAmount=saturate(fogAmount);return mix(rgb,fogCol,fogAmount);}vec4 texture3d(sampler2D t,vec3 p,vec3 n,float scale){return texture(t,p.yz*scale)*abs(n.x)+texture(t,p.zx*scale)*abs(n.y)+texture(t,p.xy*scale)*abs(n.z);}vec3 lensflare(vec2 uv,vec2 pos){vec2 main=uv-pos;vec2 uvd=uv*(length(uv));float ang=atan(main.x,main.y);float dist=length(main);dist=pow(dist,.1);float n=hash12(vec2(ang*16.0,dist*32.0));float f0=1.0/(length(uv-pos)*16.0+1.0);f0=f0+f0*(sin(hash11((pos.x+pos.y)*2.2+ang*4.0+5.954)*16.0)*.1+dist*.1+.8);float f1=max(0.01-pow(length(uv+1.2*pos),1.9),.0)*7.0;float f2=max(1.0/(1.0+32.0*pow(length(uvd+0.8*pos),2.0)),.0)*00.25;float f22=max(1.0/(1.0+32.0*pow(length(uvd+0.85*pos),2.0)),.0)*00.23;float f23=max(1.0/(1.0+32.0*pow(length(uvd+0.9*pos),2.0)),.0)*00.21;vec2 uvx=mix(uv,uvd,-0.5);float f4=max(0.01-pow(length(uvx+0.4*pos),2.4),.0)*6.0;float f42=max(0.01-pow(length(uvx+0.45*pos),2.4),.0)*5.0;float f43=max(0.01-pow(length(uvx+0.5*pos),2.4),.0)*3.0;uvx=mix(uv,uvd,-.4);float f5=max(0.01-pow(length(uvx+0.2*pos),5.5),.0)*2.0;float f52=max(0.01-pow(length(uvx+0.4*pos),5.5),.0)*2.0;float f53=max(0.01-pow(length(uvx+0.6*pos),5.5),.0)*2.0;uvx=mix(uv,uvd,-0.5);float f6=max(0.01-pow(length(uvx-0.3*pos),1.6),.0)*6.0;float f62=max(0.01-pow(length(uvx-0.325*pos),1.6),.0)*3.0;float f63=max(0.01-pow(length(uvx-0.35*pos),1.6),.0)*5.0;vec3 c=vec3(.0);c.r+=f2+f4+f5+f6;c.g+=f22+f42+f52+f62;c.b+=f23+f43+f53+f63;c=c*1.3-vec3(length(uvd)*.05);c+=vec3(f0);return c;}";
const char* post_processing_shader_glsl_frag = "#version 430\nlayout(location=0)out vec4 C0;layout(location=2)out vec4 C2;layout(location=3)uniform vec4 p[3];layout(binding=0)uniform sampler2D B0;layout(binding=1)uniform sampler2D B1;layout(binding=2)uniform sampler2D B2;in vec2 uv;vec2 ouv;float alpha;\n#define M0 1597334673U\n#define M1 3812015801U\n#define M2 uvec2(M0, M1)\nfloat hash12(vec2 p){uvec2 q=uvec2(ivec2(p))*M2;uint n=(q.x^q.y)*M0;return float(n)*(1./float(0xffffffffU));}vec4 bloom=vec4(0),blur=vec4(0),ftex;\n#define GA 2.399\nmat2 rot=mat2(cos(GA),sin(GA),-sin(GA),cos(GA));vec3 pixel;vec3 pixels[]=vec3[](vec3(.0006,.0006,1.),vec3(.0003,.0003,1.),vec3(.0005,.0005,1.),vec3(.002,.0005,.6));float intensity(vec4 col){return dot(col.rgb,vec3(0.2126,0.7152,0.0722));}void dof(sampler2D tex,vec2 uv,float rad,vec4 org){vec2 angle=vec2(0,rad);vec4 col=texture(tex,uv);for(int j=0;j<48;j++){rad+=1./rad;angle*=rot;col=texture(tex,uv+pixel.xy*(rad-1.)*angle);if(intensity(col)>.9){bloom+=col;}blur+=col;}blur/=48.;}void mainImage(){vec2 res=1./p[0].yz;vec4 orgColor=texture(B1,ouv)+texture(B1,ouv+res.xy)*.5+texture(B1,ouv+res.yx)*.5+texture(B1,ouv-res.xy)*.5+texture(B1,ouv-res.yx)*.5;orgColor/=5.;dof(B1,ouv,pixel.z,orgColor);orgColor=mix(orgColor,blur,clamp(abs(alpha+pow(length(uv),3.)),0.,1.)*ftex.b);orgColor=mix(orgColor,orgColor.rrga,clamp(pow(max(0.,length(uv)-.1),4.),0.,1.)*ftex.a);orgColor+=abs(bloom/ 96)*ftex.g;C0=orgColor*1.2;}void main(){ftex=texelFetch(B2,ivec2(6,0),0);pixel=pixels[int(ftex.b)];ouv=(uv+1.)/2.;alpha=texture(B1,ouv).a;mainImage();if(p[1].y<1.){vec4 f=texelFetch(B2,ivec2(5,0),0);C0=mix(C0,vec4(f.y),f.z);}}";
const char* vertex_vert = "#version 430\nlayout(location=0)in vec2 i;out vec2 p;out gl_PerVertex{vec4 gl_Position;};void main(){gl_Position=vec4(i,0.,1.);p=i;}";
const char* calc_frag = "int X;\n#define PATTERN_TIME 5.485714\nvoid main(){ivec2 store=ivec2(gl_FragCoord.xy);uv=gl_FragCoord.xy/ U[0].yz;C2=vec4(0.0);float ck=cos(iTime*.1)*.1;int index=0;if(store.y>0||store.x>10){C2.r=noiseLayers(vec3(uv*10.,2.));C2.g=noiseFF(uv*6.);}else{vec3 keyTime=vec3(0.);vec2 T[]=vec2[](vec2(0.,0.),vec2(PATTERN_TIME,1.),vec2(PATTERN_TIME*8.,1.),vec2(PATTERN_TIME*9.,1.),vec2(PATTERN_TIME*10.,1.),vec2(PATTERN_TIME*12.,1.),vec2(PATTERN_TIME*22.,1.),vec2(PATTERN_TIME*28.,1.),vec2(PATTERN_TIME*32.,1.),vec2(PATTERN_TIME*230.,1.));for(int i=0;i<T.length()-1;i++){if(T[i+1].x>iTime){float st=iTime-T[i].x;keyTime.g=st;keyTime.r=(st/(T[i+1].x-T[i].x))*T[i].y;keyTime.b=mod(iTime,PATTERN_TIME);break;}}vec3 s1_ob=vec3(iTime*2.-40.,20.,92.);if(iTime>PATTERN_TIME*12.)s1_ob=vec3(-keyTime.g*28.,0.,0.);if(iTime>PATTERN_TIME*22.)s1_ob=vec3(138.,24.5,iTime+1020+keyTime.r*3.);switch(store.x){case 0:vec4[]CAMS=vec4[](vec4(0.,iTime-15.,20.,91.2),vec4(PATTERN_TIME*3.,iTime-15.,22.,91.2),vec4(PATTERN_TIME*7.,iTime*2.-38.,19.9,91.3),vec4(PATTERN_TIME*8.,iTime*2.-38.,19.9,91.3),vec4(PATTERN_TIME*10.,iTime*2.-38.-keyTime.g,19.9,91.3),vec4(PATTERN_TIME*12.,-1.-keyTime.g*27.,2.,-1.),vec4(PATTERN_TIME*13.,6.-keyTime.g*28,4.,5.),vec4(PATTERN_TIME*14.,-3.-keyTime.g*27-13.,20.,-10.),vec4(PATTERN_TIME*15.,21.-keyTime.g*29.,3.,11.),vec4(PATTERN_TIME*16,21.-keyTime.g*29.,4.,1.),vec4(PATTERN_TIME*18.,-33.-keyTime.g*27.,4.,-4.),vec4(PATTERN_TIME*20.,-iTime*2.,53.,1200.),vec4(PATTERN_TIME*21.,-iTime*1.,33.,1200.),vec4(PATTERN_TIME*22.,149.,38.5,iTime+1020.),vec4(PATTERN_TIME*24.,139.,24.5,iTime+1020.),vec4(PATTERN_TIME*32.,keyTime.g*.2-14.,0.,keyTime.g),vec4(1e9));for(int i=0;i<(CAMS.length()-1);i++){if(CAMS[i+1].x>iTime){C2.rgb=CAMS[i].yzw;break;}}break;case 2:vec4[]LAT=vec4[](vec4(0.,iTime+30.,20.,91.2),vec4(PATTERN_TIME*3.,iTime+30.,10.,91.2),vec4(PATTERN_TIME*7.,s1_ob),vec4(PATTERN_TIME*12.,s1_ob),vec4(PATTERN_TIME*20.,vec3(-iTime*2.,43.,1300.)+vec3(80.,-40.,40.)),vec4(PATTERN_TIME*21.,vec3(-iTime*2.,43.,2100.)-vec3(-20.,190.,0.)),vec4(PATTERN_TIME*22.,137.,25.,iTime+1040.),vec4(PATTERN_TIME*24.,137.,25.,iTime+1040.),vec4(PATTERN_TIME*32.,keyTime.g*.2+24.,0.,keyTime.g-10.),vec4(1e9));for(int i=0;i<(LAT.length()-1);i++){if(LAT[i+1].x>iTime){C2.rgb=LAT[i].yzw;break;}}break;case 3:C2.rgb=s1_ob;return;case 4:C2.rgb=keyTime;return;case 5:vec4 K[]=vec4[](vec4(0.,0.,1.,0.01),vec4(0.02,0.,0.,0.9),vec4(PATTERN_TIME*3-2.,0.,1.,2.),vec4(PATTERN_TIME*3.,0.,0.,1.),vec4(PATTERN_TIME*12-2.,1.,1.,2.),vec4(PATTERN_TIME*12,1.,0.,.5),vec4(PATTERN_TIME*13-.5,0.,1.,.5),vec4(PATTERN_TIME*13,0.,0.,.5),vec4(PATTERN_TIME*14-.5,0.,1.,.5),vec4(PATTERN_TIME*14,0.,0.,.5),vec4(PATTERN_TIME*15-.5,0.,1.,.5),vec4(PATTERN_TIME*15,0.,0.,.5),vec4(PATTERN_TIME*16-.5,1.,1.,.5),vec4(PATTERN_TIME*16,1.,0.,.5),vec4(PATTERN_TIME*18-.5,0.,1.,.5),vec4(PATTERN_TIME*18,0.,0.,5.),vec4(PATTERN_TIME*20-2.,0.,1.,2.),vec4(PATTERN_TIME*20,0.,0.,.5),vec4(PATTERN_TIME*21-.5,0.,1.,.5),vec4(PATTERN_TIME*21,0.,0.,.5),vec4(PATTERN_TIME*22-.5,0.,1.,.5),vec4(PATTERN_TIME*22,0.,0.,.5),vec4(PATTERN_TIME*24-.5,0.,1.,.5),vec4(PATTERN_TIME*24,0.,0.,.5),vec4(PATTERN_TIME*28-4.,1.,1.,4.),vec4(PATTERN_TIME*28,1.,0.,1.),vec4(PATTERN_TIME*32-4.,1.,1.,4.),vec4(PATTERN_TIME*32,1.,0.,1.),vec4(PATTERN_TIME*40-8.,0.,1.,8.),vec4(PATTERN_TIME*44-4,1.,1.,4.),vec4(PATTERN_TIME*99,0.,1.,1.),vec4(120,0.,0.,1.));for(int i=1;i<K.length()-1;i++){if(K[i+1].x>iTime){vec4 WB=K[i];WB.z=mix(K[i-1].z,K[i].z,min(1.,(iTime-K[i].x)/K[i].w));C2=WB;break;}}return;case 6:vec4 PP[]=vec4[](vec4(0.,1.,1.,1.),vec4(PATTERN_TIME*12,3.,1.,2.),vec4(PATTERN_TIME*20.,0.,0.,.0),vec4(PATTERN_TIME*28,1.,1.0,1.0),vec4(PATTERN_TIME*32,0.,0.,0.0),vec4(1e2,0.,0.,.0));for(int i=0;i<(PP.length()-1);i++){if(PP[i+1].x>iTime){C2.rgb=PP[i].yzw;break;}}C2.a=1.;if(iTime>PATTERN_TIME*12.&&iTime<PATTERN_TIME*28.)C2.a=0.;return;default:discard;break;}}}";
const char* scene1_frag = "geometry map(vec3 p){vec3 bp=p;vec3 op=p;vec3 wp=p;vec4 tex=texture(B2,(bp.xz/ 628.-.32));float n;geometry o1,o2,o3,o4,o5,o6;o1.d=FAR;o2=o3=o4=o5=o6=o1;if(bp.y<26.){n=tex.r*13.;p.y-=pow(abs(n),1.4);o1.d=fBox2Cheap(p.xy,vec2(1e32,3.));o1.mat=2;o1.sp=p;if(o1.d<1.){float n2=smoothstep(.02,1.,.3+texture(B2,p.zx*.01+p.xz*.15).g)*.7;p.y-=pow(n2,2.)*2.5-2.2+tex.g*6.9;o2.d=fBox2Cheap(p.xy,vec2(1e32,2.9))*.2;o2.mat=3;o2.sp=p;}}else{o1.d=bp.y+1.;o2.d=o1.d;}p=bp;p.y-=20.;p.z-=92.;wp=p;if(length(wp.yz)-1.>1.1){o3.d=length(wp.yz)-1.;}else{vec3 ap=p;float i=pModInterval1(p.x,2.,-20.,26.);o3.d=tritun(p);o3.mat=0;p=ap;vec3 shp=s1_ob-op;o4=fShip(shp);shp=s1_ob-op;vec3 shpX=shp;vec3 r1=wp;r1.x-=59.;if(s1_ob.x>59.){r1.x=shp.x;pR(r1.xy,pow(s1_ob.x-59.,1.4));}o6.d=ring(r1.zxy,vec4(.5,.05,.01,.01));r1=wp;r1.x-=65.;if(s1_ob.x>65.){r1.x=shp.x;pR(r1.xy,pow(s1_ob.x-65.,1.5));pR(r1.xz,pow((s1_ob.x-65.)*.8,1.5));}o6.d=min(o6.d,ring(r1.zxy,vec4(.55,.05,.01,.01)));r1=wp;r1.x-=70.;if(s1_ob.x>70.){r1.x=shp.x;pR(r1.xy,pow(s1_ob.x-70.,1.6));}o6.d=min(o6.d,ring(r1.zxy,vec4(.6,.05,.01,.01)));o6.mat=4;geometry port=o1;port.d=fDisc(wp.zxy+vec3(0.,-86.,0.),2.);port.color=vec4(0.);port.mirror=1.;port.d=smin(port.d,o4.d+.1,.7+noiseShort(wp*.1)*.2);o3=geoU(o3,port);o6.d=min(o6.d,fDisc(wp.zxy+vec3(0.,-86.,0.),3.));o3=geoU(o6,geoU(o3,o4));p=wp;}p=bp;p.x-=120.;o5.d=FAR;o5.mat=1;return geoU(geoU(geoU(o1,o2),o3),o5);}void mainImage(){CI s1_ob=texelFetch(B2,ivec2(3,0),0).rgb;vec3 ro=texelFetch(B2,ivec2(0,0),0).rgb;vec3 vrp=texelFetch(B2,ivec2(2,0),0).rgb,vpn=normalize(vrp-ro),u=normalize(cross(vuv,vpn)),v=cross(vpn,u),vcv=(ro+vpn),scrCoord=(vcv+uv.x*u*16./9.+uv.y*v),rd=normalize(scrCoord-ro);vec4 c=vec4(0.);geometry tr=trace(ro,rd),otr=tr;vec3 sky=mix(vec3(.5,.5,.5)*2.5,vec3(.7,.9,1.),max(0.,rd.y*2.+.5)),sceneColor=sky;vec3 light=vec3(100.,40.,100.);vec3 sn;float alpha=1.;if(tr.d<FAR){float fog=smoothstep(FAR*FOG,0.,tr.d/ 6.);tr.hp=ro+rd*tr.d;alpha=tr.d/ FAR*4.;sn=normals(tr.hp);float sh=softShadow(tr.hp,ro+light,13.);float ao=getAO(tr.hp,sn,2.6);vec4 col=doColor(tr.hp,rd,sn,light,tr);sceneColor=col.rgb;sceneColor*=sh*ao;sceneColor+=texture(B2,tr.sp.xz*.025+iTime*.04).g*.3;sceneColor+=texture(B2,tr.sp.xz*.015+iTime*.01).g*.6;sceneColor=applyFog(sceneColor,tr.d,ro,rd,sky);if(tr.mirror>0.){rd=reflect(rd,sn);tr.hp+=rd*.02;tr=trace(tr.hp,rd);tr.hp=tr.hp+rd*tr.d;vec3 refl;if(tr.d<FAR){sn=normals(tr.hp);sh=softShadow(tr.hp,tr.hp+light,13.);ao=getAO(tr.hp,sn,2.6);refl=doColor(tr.hp,rd,sn,light,tr).rgb*ao*sh*2.;}else{refl=mix(vec3(.5,.5,.5)*2.5,vec3(.7,.9,1.),max(0.,rd.y*2.+.5));}sceneColor=mix(sceneColor,refl,otr.mirror*.75);}sceneColor=mix(sceneColor,sky,otr.d/ FAR);}else{tr.d=FAR;}vec2 sunuv=2.7*vec2(dot(normalize(light),u),dot(normalize(light),v));vec3 lens=vec3(1.4,1.2,1.0)*(lensflare(uv*2.7,sunuv)*1.);sceneColor*=.5;sceneColor+=lens*.31;C1=vec4(sceneColor,alpha);}void loader(){uv=ouv;C1=vec4(0.);if(abs(uv.y)<.01){if(abs(uv.x)<(U[0].x/ 20.)){C1=vec4(.3)-max(.0,(U[0].x-17.))/3.;}}}void main(){if(U[1].y<1.){mainImage();}else{loader();}C0=texelFetch(B0,ivec2(gl_FragCoord.xy),0);C2=texelFetch(B2,ivec2(gl_FragCoord.xy),0);}";
const char* scene2_frag = "float yC(float x){return cos(x*-.0134)*2.*sin(x*.13)*15.;}geometry map(vec3 p){p.x-=yC(p.y*.1)*3.;p.z+=yC(p.y*.01)*4.;float n=pow(abs(fbm(p*.06+vec3(0.,iTime*0.14,0.)))*12.,1.3);float s=fbm(p*0.01+vec3(0.,iTime*0.14,0.))*128.;geometry obj;obj.d=0.;obj.d=max(obj.d,-fCylinder(p,s+18.-n,1e9));p.x-=sin(p.y*.02)*34.+cos(p.z*0.01)*62.;obj.d=max(obj.d,-fCylinder(p,s+28.+n*2.,1e9))*.8;return obj;}void mainImage(){CI uv=ouv*.5;uv*=2.;vec3 vuv=normalize(vec3(cos(iTime*.4),sin(iTime*.4),sin(iTime*.4)));vec3 ro=vec3(0.,30.+iTime*40.,-.1);ro.x+=yC(ro.y*.1)*3.;ro.z-=yC(ro.y*.01)*4.;vec3 vrp=vec3(0.,50.+iTime*100.,2.);vrp.x+=yC(vrp.y*.1)*3.;vrp.z-=yC(vrp.y*.01)*4.;vec3 vpn=normalize(vrp-ro),u=normalize(cross(vuv,vpn)),v=cross(vpn,u),vcv=(ro+vpn),scrCoord=(vcv+uv.x*u*16./9.+uv.y*v),rd=normalize(scrCoord-ro),oro=ro;vec3 sceneColor=vec3(0.);geometry tr=trace(ro,rd);tr.hp=ro+rd*tr.d;vec3 col=vec3(1.,0.5,.4)*fbm(tr.hp.xzy*.01)*20.;col.b*=fbm(tr.hp*.01)*10.;float alpha=tr.d/FAR;sceneColor*=1.+.9*(abs(fbm(tr.hp*.002+3.)*10.)*(fbm(vec3(0.,0.,iTime*.05)*2.))*1.);sceneColor=pow(sceneColor,vec3(1.));vec3 steamColor1=vec3(.0,.4,.5);vec3 rro=oro;ro=tr.hp;float distC=tr.d,f=0.,st=.9;for(float i=0.;i<24.;i++){rro=ro-rd*distC;f+=fbm(rro*vec3(.1,.1,.1)*.3)*.1;distC-=3.;if(distC<3.)break;}sceneColor+=min(.8,float(tr.i)/130.)*col+col*.01;sceneColor+=steamColor1*pow(abs(f*1.5),3.)*5.;sceneColor=pow(sceneColor,1./vec3(1.4))*.6;C1=vec4(clamp(sceneColor,0.0,1.0),alpha)*1.2;}void main(){mainImage();C0=texelFetch(B0,ivec2(gl_FragCoord.xy),0);C2=texelFetch(B2,ivec2(gl_FragCoord.xy),0);}";
const char* scene3_frag = "vec3 lightColour=normalize(vec3(1.8,1.0,0.3));vec3 fromRGB(int r,int g,int b){return vec3(float(r),float(g),float(b))/255.;}bool inball=false;vec3 light=vec3(0.0),p=vec3(0.),p2=vec3(0.),lightDir=vec3(0.);vec3 DE(vec3 p){const float scale=1.45;const float offset=2.0;const int FRACTALITERATIONS=15;vec3 modifier=vec3(-12.3,-4.1,-4.1);p.y=-p.y;for(int n=0;n<FRACTALITERATIONS;n++){p.xy=(p.x+p.y<=0.0)?-p.yx:p.xy;p.xz=(p.x+p.z<=0.0)?-p.zx:p.xz;p.zy=(p.z+p.y<=0.0)?-p.yz:p.zy;p.y-=4.1;pR(p.xz,0.82915);p.yz=-p.zy*vec2(1.,-1.);p.x-=30.;pR(p.zx,-.46915);p=scale*p-offset*(scale-1.0)*modifier;}vec3 obj;obj.x=length(p)*pow(scale,-float(FRACTALITERATIONS-1))*.2-.001;return obj;}geometry map(vec3 p){vec3 bp=p;vec3 r=pMod3(p,vec3(100.));p.x+=noise_3(r.xzy)*23.;geometry obj,obj2;obj2.d=FAR;obj.d=FAR;obj.mat=2;if(inball){obj.d=min(obj.d,DE(p).x);obj2.mat=3;obj=geoU(obj,obj2);}else{obj.d=min(obj.d,fSphere(p,30.-noiseShort(p*.05+iTime*.1)*1.));p+=10.;}return obj;}vec3 Sky(in vec3 rd,bool showSun,vec3 lightDir){return noiseShort(rd*2.)*vec3(1.,.5,.3)*2.;}void mainImage(){CI uv=ouv*.5;uv*=1.;float t2=keyTime.g-35.;float sk=iTime,ck=cos(t2*.03+2.2)*162.0,mat=0.;light=vec3(0.,17.,100.);lightDir=light;vec3 vuv=vec3(sin(keyTime.g/ 10.)*.3,1.,sin(keyTime.g/ 10.)*.3),ro=vec3(224.3,230.,sk);ro=texelFetch(B2,ivec2(0,0),0).rgb;vec3 vrp=texelFetch(B2,ivec2(2,0),0).rgb,vpn=normalize(vrp-ro),u=normalize(cross(vuv,vpn)),v=cross(vpn,u),vcv=(ro+vpn),scrCoord=(vcv+uv.x*u*16./9.+uv.y*v),rd=normalize(scrCoord-ro);vec3 sceneColor=vec3(0.);geometry tr=trace(ro,rd),otr;float fog=smoothstep(FAR*FOG,0.,tr.d);tr.hp=ro+rd*tr.d;otr=tr;vec3 sky=Sky(rd,true,normalize(light))*1.;float alpha=1.;if(tr.d<FAR){vec3 sn=normals(tr.hp);float sh=softShadow(tr.hp,tr.hp+light,3.);sceneColor+=0.2;vec3 bcol=vec3(0.);tr.hp+=rd;inball=true;if(tr.d>0.){rd=refract(rd,sn,1.-min(1.,tr.d/ 100.));bcol=vec3(1.,.5,.0)*pow(abs(fbm(sn*1.))*2.3,7.)*1.3;bcol+=pow(max(0.,dot(rd,normalize(light)))*1.1,23.)*.1;tr=trace(tr.hp,rd);tr.hp+=tr.d*rd;}else{tr=trace(ro,rd);tr.hp=ro+tr.d*rd;alpha=tr.d/ FAR;}if(tr.d<FAR){sceneColor+=vec3(1.,.5,.0)/abs(tr.d)*15.;sceneColor+=mix(sceneColor,sky,clamp(otr.d/ FAR,0.,1.));}else{sceneColor+=mix(sceneColor,sky,clamp(otr.d/ FAR,0.,1.));}sceneColor+=bcol;}else{sceneColor=sky;}sceneColor+=pow((float(otr.i)/120.),1.3);C1.rgb=sceneColor;C1.a=alpha;C1.rgb*=.6;}void main(){mainImage();C0=texelFetch(B0,ivec2(gl_FragCoord.xy),0);C2=texelFetch(B2,ivec2(gl_FragCoord.xy),0);}";
const char* scene4_frag = "vec3 fromRGB(int r,int g,int b){return vec3(float(r),float(g),float(b))/255.;}vec3 light=vec3(0.0),p=vec3(0.),p2=vec3(0.),lightDir=vec3(0.);vec3 lightColour=normalize(vec3(1.8,1.0,0.3));geometry DE(vec3 np,float c){vec3 p=np;const float scale=2.7;const float offset=9.;const int FRACTALITERATIONS=10;vec3 modifier=vec3(19.3,-3.,3.2);for(int n=0;n<FRACTALITERATIONS;n++){p=abs(p);p.xy=(p.x-p.y<0.0)?p.yx:p.xy;p.zy=(p.y-p.z<0.0)?p.yz:p.zy;p.x+=80.;pR(p.xy,.725);p.zy+=22.;p.xyz=scale*p.xyz-offset*(scale-.3)*modifier.xyz;}geometry obj,obj2;obj.d=fBox(p,vec3(1e2,1e2,1.))*(pow(scale,-float(FRACTALITERATIONS)));obj.mat=-1;obj.sp=p;return obj;}float intube=0.;geometry map(vec3 p){vec3 bp=p;bp.zyx=mod(bp.zyx,vec3(150.,150.,50.))-vec3(75.,75.,25.);geometry obj,sh,tub;obj=DE(bp,2.3);obj.d=max(obj.d,-length(p.zy)+8.);obj.color=vec4(1.,.5,.0,1.);obj.mirror=0.;obj.sp=bp;sh=fShip((s1_ob-p)*vec3(-1.,1.,1.)*.1);sh.d*=10.;return geoU(obj,sh);}vec3 Sky(in vec3 rd,bool showSun,vec3 lightDir){float sunSize=3.5;float sunAmount=max(dot(rd,lightDir),0.4);float v=pow(max(0.,1.2-max(rd.y,0.0)),1.1);vec3 sky=mix(fromRGB(100,136,254),vec3(.4,.5,1.3)*2.,v);if(showSun==false)sunSize=.1;sky+=lightColour*sunAmount*sunAmount*1.+lightColour*min(pow(sunAmount,222.0)*sunSize,0.2*sunSize);return clamp(sky,0.0,1.0);}void mainImage(){CI s1_ob=texelFetch(B2,ivec2(3,0),0).rgb;uv=ouv*.5;if(abs(uv.y)>.4){discard;return;}uv*=3.;float t2=iTime-35.,sk=sin(-t2*.4)*6.0,ck=cos(-t2*.4)*2.0,mat=0.;vec3 ro=texelFetch(B2,ivec2(0,0),0).rgb,oro=ro;vec3 lp=vec3(.0,0.,ro);light=+ro;vec3 vuv=vec3(0.,1.,0.);vec3 vrp=texelFetch(B2,ivec2(2,0),0).rgb,vpn=normalize(vrp-ro),u=normalize(cross(vuv,vpn)),v=cross(vpn,u),vcv=(ro+vpn),scrCoord=(vcv+uv.x*u*16./9.+uv.y*v),rd=normalize(scrCoord-ro),ord=rd;vec4 sceneColor=vec4(0.);geometry tr=trace(ro,rd),otr=tr;float ao=1.,alpha=1.,sh=0.;tr.hp=ro+rd*tr.d;otr=tr;if(tr.d<FAR){vec3 sn=normals(tr.hp),osn=sn;otr=tr;sceneColor+=doColor(tr.hp,rd,sn,lp,tr)/length(tr.hp.zy)*.1;sh=softShadow(tr.hp,s1_ob+vec3(10.,0.,10.),12.5);ao=getAO(tr.hp,sn,3.1);alpha=distance(s1_ob,tr.hp)*.02;sceneColor*=ao*sh;if(tr.mirror>0.){rd=reflect(rd,sn);tr=trace(ro,rd);tr.hp=ro+rd*tr.d;vec3 refl;if(tr.d<FAR){sn=normals(tr.hp);sh=softShadow(tr.hp,ro+lp,13.);refl=doColor(tr.hp,rd,sn,lp,tr).rgb*ao*sh;refl=mix(sceneColor,vec4(.1),clamp(otr.d/ 210.,0.,1.)).rgb;}else{refl=mix(vec3(.5,.5,.5)*2.5,vec3(.7,.9,1.),max(0.,rd.y*2.+.5));}sceneColor.rgb=mix(sceneColor.rgb,refl,otr.mirror);sceneColor.rgb*=cross(ord,-osn);}}else{tr.d=FAR;alpha=1.;}float flareDist=1e9,camFlareDist=1e9;vec3 flareCol=vec3(0.),flareCol_B=vec3(0.);float ti=keyTime.g;for(float k=0.;k<128.;k++){vec3 flarePos=vec3(sin(k/ 32.)*60.+s1_ob.x-30.,-cos(k/ 6.-ti/ 2.)*sin(k-k*0.1+sin(ti/ 13.)*2.)*15.,cos(ti/ 3.+k/ 12.)*(sin(ti*.2+k)/2.+.8)*15.);flareDist=min(distance(tr.hp,flarePos),flareDist);camFlareDist=min(distance(ro,flarePos),camFlareDist);if(tr.d>distance(flarePos,ro)){flareCol_B+=abs(vec3(1.,0.2,0.)*pow(max(0.,dot(normalize(-ro+flarePos)*0.99,rd)*1.01),1e3)*.04);flareCol+=abs(vec3(1.,.2,0.)*pow(pow(max(0.,dot(normalize(-ro+flarePos),rd)),1e5-distance(ro,flarePos)*140.)/distance(ro,flarePos)*100.,3.));alpha=tr.d/ FAR;}}if(flareCol.r<.0){tr.d=camFlareDist;}flareCol+=flareCol_B;sceneColor+=pow(vec4(1.,0.2,0.,0.)/(flareDist/ 4.),vec4(1.3))*1.;sceneColor*=ao;sceneColor=mix(sceneColor,vec4(.1),clamp(otr.d/ 210.,0.,1.));vec3 clight=vec3(s1_ob)-vec3(24.,0.,0.);sceneColor.rgb=pow(sceneColor.rgb,1./vec3(1.4));C1=vec4(clamp(sceneColor.rgb*(1.-length(uv)/2.5),0.0,1.0),alpha);C1.rgb+=pow(flareCol*2.,vec3(0.5))*0.4;}void main(){mainImage();C0=texelFetch(B0,ivec2(gl_FragCoord.xy),0);C2=texelFetch(B2,ivec2(gl_FragCoord.xy),0);}";
const char* scene5_frag = "geometry map(vec3 p){vec3 bp=p,p2=p;float n=noiseFF(p.zx*.001-.21)*20.;geometry o,obj,obj2,ship;o.d=FAR;o.mirror=0.;obj2=obj=o;n-=noiseFF(p.xz*0.01)*3.3;n-=pow(max(0.,sin(noiseFF(p.zx*0.04)))*1.5,2.);n-=noiseFF(p.xz*0.01/ n)*3.3;p.y+=pow(abs(sin(n)+n)-3.,2.5)*.1-20.;obj.d=fBox2Cheap(p.xy,vec2(1e9,4.))*1.;obj.color=vec4(1.,.5,.5,0.);obj.sp=bp;bp-=vec3(137.,23.,iTime+1150.);bp.y-=1.5;bp.x+=6.;obj.d=min(obj.d,trits(bp));vec3 sh=(s1_ob-p2).zyx;ship=fShip(sh);ship.d*=.7;obj=geoU(obj,ship);return obj;}float ss(vec3 ro,vec3 lp,float k){const int maxIterationsShad=18;vec3 rd=lp;float shade=1.;float dist=2.01;float end=max(length(rd),0.01);float stepDist=end/ float(maxIterationsShad);rd/=end;for(int i=0;i<maxIterationsShad;i++){float h=map(ro+rd*dist).d;shade=min(shade,smoothstep(0.0,1.0,k*h/ dist));dist+=min(h,stepDist*2.);if(h<0.001||dist>end)break;}return min(max(shade,0.0),1.0);}vec4 Sky(in vec3 rd,bool showSun,vec3 lightDir,vec3 ro){float sunSize=.0;float sunAmount=max(dot(rd,normalize(lightDir)),0.1);float v=pow(1.-max(rd.y,0.0),2.);vec4 cl=vec4(0.2,.0,0.,1.)*1.;vec4 sky=mix(cl,vec4(0.6,.5,0.5,1.),v);vec4 lightColour=vec4(1.,.5,0.0,0.);sky+=1.*cl*sunAmount*sunAmount+lightColour*min(pow(sunAmount,1222.0)*sunSize,sunSize);return clamp(sky,0.0,1.0);}vec4 doColor2(in vec3 sp,in vec3 rd,in vec3 sn,in vec3 lp,geometry obj){vec4 sceneCol=vec4(0.0);lp=sp+lp;vec3 ld=lp-sp;float lDist=max(length(ld/ 2.),0.001);ld/=lDist;float atten=1./(1.0+lDist*0.025+lDist*lDist*0.2);float diff=max(dot(sn,ld),.9)*1.;float spec=pow(max(dot(reflect(-ld,sn),-rd),1.),5.5);vec4 objCol=getObjectColor(sp,sn,obj);sceneCol+=obj.color*(diff+.15)+spec*.05;sceneCol.a=objCol.a;return sceneCol;}void mainImage(){CI s1_ob=texelFetch(B2,ivec2(3,0),0).rgb;vec3 ro=texelFetch(B2,ivec2(0,0),0).rgb;float t2=iTime-35.;float sk=sin(-t2*.4)*32.0,ck=cos(-t2*.4)*32.0;vec3 vuv=vec3(0.,1.,0.);vec3 vrp=texelFetch(B2,ivec2(2,0),0).rgb,vpn=normalize(vrp-ro),u=normalize(cross(vuv,vpn)),v=cross(vpn,u),vcv=(ro+vpn),scrCoord=(vcv+uv.x*u*16./9.+uv.y*v),rd=normalize(scrCoord-ro);vec3 gr1=vec3(44.,76.,124.)/255.;vec3 gr2=vec3(190.,90.,40.)/255.;geometry tr=trace(ro,rd),otr=tr;;float fog=smoothstep(FAR*FOG,0.,tr.d/ 6.);tr.hp=ro+rd*tr.d;vec3 lp=(vec3(100.,170.,100.))+ro;vec3 sky=Sky(rd,true,lp,ro).rgb;vec3 sceneColor=sky;float alpha=0.;if(tr.d<FAR){vec3 sn=normals(tr.hp);float sh=ss(tr.hp,lp,6.);vec4 col=doColor2(tr.hp,rd,sn,lp*1.+ro,tr)*1.;sceneColor=col.rgb;sceneColor=mix(sceneColor*.3,sceneColor,smoothstep(0.,1.,sh*.5));if(tr.mirror>0.){rd=reflect(rd,sn);tr=trace(tr.hp+rd*0.1,rd);tr.hp=tr.hp+rd*tr.d;vec3 refl=vec3(1.0,0.,0.);if(tr.d<FAR){sn=normals(tr.hp);sh=softShadow(tr.hp,ro+lp,13.);refl=doColor2(tr.hp,rd,sn,lp,tr).rgb*sh;}else{refl=mix(vec3(.5,.5,.5)*2.5,vec3(.7,.9,1.),max(0.,rd.y*2.+.5));}sceneColor=mix(sceneColor,refl,otr.mirror);}sceneColor=mix(sceneColor,sky,tr.d/FAR);}else{vec3 rd2=rd;sceneColor+=pow(stars(rd),vec3(1.))*1.;}vec3 clight=lp;vec2 sunuv=2.7*vec2(dot(normalize(clight),u),dot(normalize(clight),v));vec3 lens=vec3(2.0)*max(vec3(0.),(lensflare(uv*4.,sunuv)*1.));sceneColor+=lens;C1=vec4(sceneColor,1.);}void main(){mainImage();C0=texelFetch(B0,ivec2(gl_FragCoord.xy),0);C2=texelFetch(B2,ivec2(gl_FragCoord.xy),0);}";
